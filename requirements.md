# Yet Another Economy (YAE) 需求文档

## 简介

YAE 是一个为 Minecraft Paper/Spigot 服务器设计的全服统一经济系统，提供交易、系统商店、系统回收、银行、税费等功能。系统设计遵循"价格唯一真相"、"交易必记账"、"无脑可用但不无脑送钱"的核心原则。

## 目标与范围

### 项目目标

- 提供稳定、可扩展的经济系统，覆盖交易、商店、回收、银行、税费等全场景
- 让普通玩家"只用 GUI 就能完成 95% 操作"，减少指令学习成本
- 防呆设计：避免误操作和经济漏洞（刷钱闭环）
- 可治理：管理员可以一键冻结、回滚、审计，且所有行为可追溯
- 自动化：税费包含在消费中，无需申报

### MVP 范围

- 标准价格系统（SPS）+ API + 价格广播
- Shop（基础商店）、Sell（系统回收）、Auction（拍卖）、Order（求购）
- Bank：存款账户、定期/活期利息、贷款（授信上限/抵押/还款计划）、自动扣款、逾期处理
- ChestGUI 全流程 + 指令兜底
- 反洗钱风控：关联账户图谱、异常成交检测
- 组织账户：公会/公司共享账户
- 信用评分系统

## 功能需求

### 需求 1：标准价格系统 (Standard Price System, SPS)

**用户故事：** 作为服务器管理员，我想要一个基于真实交易数据自动计算的标准价格系统，以便所有经济活动的参考价都来自统一的真相源。

#### 验收标准

1. WHEN 有任何交易成交 THEN 系统 SHALL 记录成交价格并更新价格缓存
2. WHEN 系统启动 THEN 系统 SHALL 从数据库加载历史价格数据并计算初始标准价格
3. WHEN 价格数据更新间隔到达 THEN 系统 SHALL 使用市场深度模型重新计算标准价格
4. IF 某物品的流动性低于阈值 THEN 系统 SHALL 延长该物品的价格更新周期并收窄价格波动区间
5. WHERE 在价格查询 API 中 THEN 系统 SHALL 返回标准价格、价格区间（band）和流动性等级
6. WHEN 管理员手动调整标准价格 THEN 系统 SHALL 记录调整原因并触发价格广播
7. WHEN 系统计算标准价格 THEN 系统 SHALL 考虑买卖盘深度和近期成交量

### 需求 2：基础商店系统 (Shop)

**用户故事：** 作为玩家，我想要从系统商店购买物品，以便快速获取基础物资。

#### 验收标准

1. WHEN 玩家打开 Shop GUI THEN 系统 SHALL 显示可购买物品的分类列表
2. WHEN 玩家选择物品 THEN 系统 SHALL 显示物品详情页，包含商店价、标准价格系统参考价、价格区间
3. WHEN 玩家调整购买数量 THEN 系统 SHALL 实时计算总价并显示税费明细
4. IF 玩家余额不足 THEN 系统 SHALL 禁用购买按钮并提示"余额不足，可前往银行贷款或出售物品"
5. WHEN 玩家点击购买确认 THEN 系统 SHALL 显示二次确认界面，包含支付明细和10秒撤销提示
6. WHEN 玩家确认购买 THEN 系统 SHALL 扣除费用、交付物品并生成交易回执
7. IF 物品启用了每日限购 THEN 系统 SHALL 检查玩家当日已购买数量并阻止超限购买
8. WHEN 商店交易完成 THEN 系统 SHALL 将交易记录写入总账（Ledger）

### 需求 3：系统回收系统 (Sell)

**用户故事：** 作为玩家，我想要将多余物品出售给系统，以便快速获得货币。

#### 验收标准

1. WHEN 玩家打开 Sell GUI THEN 系统 SHALL 显示背包中可回收的物品列表（基于NBT过滤）
2. WHEN 玩家选择物品 THEN 系统 SHALL 显示回收价（标准价格系统×r_buyback）和r系数
3. IF 物品被标记为高风险 THEN 系统 SHALL 显示额外警告并使用更低的回收系数
4. WHEN 玩家调整出售数量 THEN 系统 SHALL 实时计算总收入
5. IF 启用了每日回收限额 THEN 系统 SHALL 检查玩家当日已回收数量并阻止超限出售
6. WHEN 玩家点击出售确认 THEN 系统 SHALL 显示二次确认界面并提示"回收后不可撤回"
7. WHEN 玩家确认出售 THEN 系统 SHALL 扣除物品、增加余额并生成交易回执
8. WHEN 出售交易完成 THEN 系统 SHALL 将交易记录写入总账

### 需求 4：玩家拍卖系统 (Auction)

**用户故事：** 作为玩家，我想要将物品上架出售给其他玩家，以便获得更好的价格。

#### 验收标准

1. WHEN 玩家选择上架物品 THEN 系统 SHALL 打开上架流程界面
2. WHEN 玩家设置价格 THEN 系统 SHALL 显示标准价格系统参考价和建议区间，并计算偏离税费
3. IF 玩家设置的价格偏离标准价格系统超过阈值 THEN 系统 SHALL 显示额外警告并要求二次确认
4. WHEN 玩家设置拍卖时长 THEN 系统 SHALL 显示预计上架费用
5. WHEN 玩家确认上架 THEN 系统 SHALL 冻结物品、扣除上架费并创建拍卖记录
6. WHEN 其他玩家浏览拍卖列表 THEN 系统 SHALL 支持按物品分类、价格区间、时间筛选
7. WHEN 玩家购买拍卖物品 THEN 系统 SHALL 扣除买方余额、增加卖方余额并交付物品
8. WHEN 拍卖超时未售出 THEN 系统 SHALL 自动下架并退回物品给卖方
9. WHEN 卖家主动下架 THEN 系统 SHALL 显示可能损失的上架费并确认

### 需求 5：求购订单系统 (Orders)

**用户故事：** 作为玩家，我想要发布求购订单，以便其他玩家可以接单交付物品给我。

#### 验收标准

1. WHEN 玩家发布求购订单 THEN 系统 SHALL 冻结对应资金并创建订单记录
2. WHEN 玩家设置单价 THEN 系统 SHALL 显示标准价格系统参考价和建议区间
3. WHEN 玩家设置有效期 THEN 系统 SHALL 在订单过期时自动解冻资金
4. WHEN 其他玩家浏览订单列表 THEN 系统 SHALL 显示可接单的订单（基于背包物品匹配）
5. WHEN 玩家选择接单 THEN 系统 SHALL 显示可交付数量（受背包限制）
6. WHEN 玩家确认交付 THEN 系统 SHALL 使用 FIFO+反狙击 机制处理多个同时接单的情况
7. WHEN 交付成功 THEN 系统 SHALL 扣除交付者物品、增加交付者余额、交付给求购者物品
8. WHEN 求购者取消订单 THEN 系统 SHALL 解冻资金并根据已接单情况处理

### 需求 6：银行系统 - 存款

**用户故事：** 作为玩家，我想要在银行存取款并获取利息，以便安全保管和增值资金。

#### 验收标准

1. WHEN 玩家打开银行 GUI THEN 系统 SHALL 显示可用余额、活期利率、信用评分
2. WHEN 玩家选择存款 THEN 系统 SHALL 提供 +1/+10/+100/+1000/Max 和手动输入选项
3. WHEN 玩家存入活期 THEN 系统 SHALL 记录存入时间并开始计算活期利息
4. WHEN 玩家选择定期存款 THEN 系统 SHALL 提供 7/14/30/60/90 天期限选项
5. WHEN 玩家选择定期期限 THEN 系统 SHALL 显示利率和到期收益预览
6. WHEN 玩家确认定期存款 THEN 系统 SHALL 强提示"提前支取罚息"并锁定资金
7. WHEN 玩家提前支取定期 THEN 系统 SHALL 按照配置规则计算罚息并返还剩余资金
8. WHEN 定期存款到期 THEN 系统 SHALL 自动将本息转入活期账户并通知玩家

### 需求 7：银行系统 - 贷款

**用户故事：** 作为玩家，我想要从银行贷款来扩大生产或应急，以便获得更多发展资金。

#### 验收标准

1. WHEN 玩家申请贷款 THEN 系统 SHALL 提供抵押贷款和信用贷款两种模式选择
2. IF 玩家不符合信用贷款条件 THEN 系统 SHALL 置灰该选项并显示原因
3. WHEN 玩家选择贷款金额和期限 THEN 系统 SHALL 展示还款计划表（每期金额、总利息、扣款时间）
4. WHEN 玩家选择抵押贷款 THEN 系统 SHALL 允许选择抵押物（货币/物品/股票）并显示抵押折扣率
5. WHEN 玩家确认贷款 THEN 系统 SHALL 显示冷静提示"确认后资金立刻到账并开始计息"
6. WHEN 贷款发放 THEN 系统 SHALL 增加玩家余额并开始计息
7. WHEN 到达还款日 THEN 系统 SHALL 自动从玩家账户扣款
8. IF 自动扣款失败 THEN 系统 SHALL 启动逾期处理流程（罚息→限制交易→扣押抵押→黑名单）
9. WHEN 玩家查看我的贷款 THEN 系统 SHALL 显示剩余本金、利率、下期应还、逾期状态
10. WHEN 玩家提前还款 THEN 系统 SHALL 重新计算利息并结清贷款

### 需求 8：组织账户系统

**用户故事：** 作为公会/公司管理者，我想要创建组织账户，以便多人共享资金和物品。

#### 验收标准

1. WHEN 玩家创建组织账户 THEN 系统 SHALL 要求设置组织名称和初始成员
2. WHEN 管理员配置组织权限 THEN 系统 SHALL 与 LuckPerms 等权限插件集成
3. WHEN 玩家访问组织账户 THEN 系统 SHALL 检查该玩家是否有权限
4. WHERE 在组织账户中 THEN 系统 SHALL 支持存款、取款、贷款等操作
5. WHEN 组织账户发生交易 THEN 系统 SHALL 记录操作人并写入总账
6. WHEN 组织账户逾期 THEN 系统 SHALL 限制所有成员的相关功能
7. WHEN 组织账户被冻结 THEN 系统 SHALL 通知所有成员并记录原因

### 需求 9：风控系统

**用户故事：** 作为服务器管理员，我想要检测和防止经济作弊行为，以便维护经济系统健康。

#### 验收标准

1. WHEN 系统检测到异常交易频率 THEN 系统 SHALL 标记该账户并增加风险评分
2. WHEN 系统检测到异常交易金额 THEN 系统 SHALL 触发异常成交检测流程
3. WHEN 多个账户使用相同 IP 或设备 THEN 系统 SHALL 构建关联账户图谱
4. WHEN 发现可疑的资金闭环 THEN 系统 SHALL 自动标记并建议管理员审核
5. WHEN 风险评分超过阈值 THEN 系统 SHALL 自动增加该账户的交易税费
6. WHEN 风险评分严重超标 THEN 系统 SHALL 建议管理员冻结账户并生成报告
7. WHEN 管理员查看风控报告 THEN 系统 SHALL 显示关联图谱、交易模式、风险评分
8. WHEN 管理员冻结账户 THEN 系统 SHALL 禁止该账户的所有交易行为
9. WHEN 管理员回滚交易 THEN 系统 SHALL 撤销资金变动并记录回滚原因

### 需求 10：账本与审计系统

**用户故事：** 作为服务器管理员，我想要查看所有经济行为的记录，以便进行审计和追踪。

#### 验收标准

1. WHEN 任何资金或物资变动发生时 THEN 系统 SHALL 写入 Ledger 记录
2. WHEN 交易失败或取消时 THEN 系统 SHALL 记录失败原因
3. WHEN 系统生成交易回执 THEN 系统 SHALL 包含交易编号、时间、对手方、金额、费用
4. WHEN 系统存储账本数据 THEN 系统 SHALL 对摘要数据永久保留，详细日志保留90天
5. WHEN 玩家查看个人流水 THEN 系统 SHALL 按时间倒序显示交易记录
6. WHEN 管理员查看总账 THEN 系统 SHALL 支持按玩家、物品、时间范围筛选
7. WHEN 管理员导出账本 THEN 系统 SHALL 支持 CSV/JSON 格式导出
8. WHEN 账本数据达到阈值 THEN 系统 SHALL 自动归档旧数据

### 需求 11：GUI 交互系统

**用户故事：** 作为玩家，我想要通过直观的 GUI 完成所有经济操作，以便无需记忆复杂指令。

#### 验收标准

1. WHEN 玩家输入 /yae 指令 THEN 系统 SHALL 打开经济系统主菜单
2. WHERE 在所有子页面 THEN 系统 SHALL 显示面包屑导航（如"主菜单 > 市场 > 拍卖"）
3. WHERE 在所有子页面 THEN 系统 SHALL 在右下角固定返回上一页、回主菜单、关闭按钮
4. WHEN 玩家进行消费/出售/贷款/上架操作时 THEN 系统 SHALL 强制二次确认界面
5. WHERE 在数量选择界面 THEN 系统 SHALL 提供 -64/-10/-1/+1/+10/+64/Max/输入 按钮
6. WHERE 在价格输入界面 THEN 系统 SHALL 默认显示标准价格系统参考价和建议区间
7. WHEN 按钮操作不可用时 THEN 系统 SHALL 禁用按钮并提供提示信息
8. WHEN 交易成功 THEN 系统 SHALL 显示交易回执并提供复制编号、查看流水等选项
9. WHERE 在所有 GUI 中 THEN 系统 SHALL 使用 lang.yml 中的可配置文本

### 需求 12：配置与本地化系统

**用户故事：** 作为服务器管理员，我想要自定义系统的各项参数，以便适应服务器的具体需求。

#### 验收标准

1. WHEN 系统启动 THEN 系统 SHALL 从 lang.yml 加载所有界面文本（支持中文）
2. WHEN 管理员修改配置 THEN 系统 SHALL 支持热重载或重启生效
3. WHERE 在配置文件中 THEN 系统 SHALL 允许设置税率、利率、回收系数等参数
4. WHERE 在配置文件中 THEN 系统 SHALL 允许配置黑名单物品（命令方块、屏障等）
5. WHERE 在配置文件中 THEN 系统 SHALL 允许配置每日交易限额
6. WHERE 在配置文件中 THEN 系统 SHALL 允许配置定期存款提前支取的罚息规则
7. WHEN 系统检测到配置错误 THEN 系统 SHALL 在启动时输出警告并加载默认值

## 非功能需求

### 性能需求

1. WHEN 服务器在线人数达到 200+ 时 THEN 系统 SHALL 保持响应时间低于 100ms
2. WHEN 每秒交易量达到峰值时 THEN 系统 SHALL 使用缓存机制减少数据库压力
3. WHEN 系统启动时 THEN 系统 SHALL 在 5 秒内完成价格系统初始化

### 安全需求

1. WHEN 任何交易发生时 THEN 系统 SHALL 使用事务机制保证数据一致性
2. WHEN 系统存储敏感数据时 THEN 系统 SHALL 对密码等敏感信息进行加密
3. WHEN 系统发生异常时 THEN 系统 SHALL 回滚未完成的事务

### 可靠性需求

1. WHEN 数据库连接失败时 THEN 系统 SHALL 重试连接并记录错误日志
2. WHEN 系统意外关闭时 THEN 系统 SHALL 在下次启动时检查和修复数据一致性
3. WHEN 插件更新时 THEN 系统 SHALL 自动执行数据库迁移脚本

### 兼容性需求

1. WHEN 服务器使用 Vault 经济系统时 THEN 系统 SHALL 正确读写余额
2. WHEN 服务器使用 LuckPerms 权限插件时 THEN 系统 SHALL 正确检查组织权限
3. WHEN 服务器使用 TriumphGUI 时 THEN 系统 SHALL 正确渲染所有 GUI 界面
